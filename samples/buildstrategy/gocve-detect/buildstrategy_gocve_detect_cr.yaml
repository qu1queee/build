---
apiVersion: shipwright.io/v1alpha1
kind: ClusterBuildStrategy
metadata:
  name: gocve-function-detect
  annotations:
spec:
  parameters:
  - name: function-name
    description: "A symbol table function name to look for, which is currently affected by a specific CVE"
  - name: path-to-pkg
    description: "A relative path to the binary code to be build with go"
  buildSteps:
    - name: prepare
      image: golang:1.16
      command:
        - /bin/bash
      args:
        - -c
        - |
          set -uo pipefail

          pushd $(params.shp-source-root)
            echo "go build -o $(params.shp-source-root)/mytool $(params.shp-source-root)/$(params.path-to-pkg)"
            go build -o $(params.shp-source-root)/mytool $(params.shp-source-root)/$(params.path-to-pkg)
            output=$(go tool nm $(params.shp-source-root)/mytool | grep $(params.function-name))
            if [ -z "$output" ]; then
              echo "The binary generated from $(params.path-to-pkg) is not using the $(params.function-name) function."
              exit 0
            else
              echo "The binary generated from $(params.path-to-pkg) is using the $(params.function-name) function, a CVE is present"
              exit 1
            fi
          popd
